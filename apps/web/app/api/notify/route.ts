import { NextRequest, NextResponse } from 'next/server';
import { Resend } from 'resend';

export async function POST(req: NextRequest) {
  try {
    // ğŸ” Debug: æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ˜¯å¦è®€åˆ°
    const key = process.env.RESEND_API_KEY;
    const from = process.env.FROM_EMAIL;
    console.log('ğŸ§© RESEND_API_KEY loaded:', key ? key.slice(0, 10) + '...' : 'âŒ not found');
    console.log('ğŸ§© FROM_EMAIL loaded:', from);

    if (!key) {
      return NextResponse.json({ error: 'Resend API key not loaded' }, { status: 500 });
    }

    const resend = new Resend(key);

    const body = await req.json();
    console.log('ğŸ“¨ /api/notify triggered with:', body);

    const testEmail = 'aaronn1128@gmail.com'; // ğŸ‘ˆ æ”¹æˆä½ è‡ªå·±çš„ Gmail
    const subject = `OneReserve æ¸¬è©¦é€šçŸ¥`;
    const html = `
      <div style="font-family:ui-sans-serif,system-ui">
        <h2>âœ… æ¸¬è©¦å¯„ä¿¡æˆåŠŸ</h2>
        <p>é€™æ˜¯å¾ <b>/api/notify</b> å¯„å‡ºçš„æ¸¬è©¦ä¿¡ã€‚</p>
        <p>æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}</p>
      </div>
    `;

    const result = await resend.emails.send({
      from: from || 'OneReserve <onboarding@resend.dev>',
      to: testEmail,
      subject,
      html
    });

    console.log('âœ… Resend response:', result);
    return NextResponse.json({ ok: true });
  } catch (e: any) {
    console.error('âŒ Error sending email:', e);
    return NextResponse.json({ error: e.message || 'send failed' }, { status: 500 });
  }
}
